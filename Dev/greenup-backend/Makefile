.PHONY: help run dev migrate upgrade seed test lint format clean manual app stop start

help:
	@echo "FastAPI Enterprise"
	@echo ""
	@echo "  run        - –∑–∞–ø—É—Å–∫ API"
	@echo "  dev        - –∑–∞–ø—É—Å–∫ —Å hot-reload"
	@echo "  migrate    - —Å–æ–∑–¥–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é"
	@echo "  upgrade    - –ø—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏"
	@echo "  seed       - –∑–∞–ø–æ–ª–Ω–∏—Ç—å –ë–î —Ç–µ—Å—Ç–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏"
	@echo "  test       - –∑–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã"
	@echo "  lint       - –ø—Ä–æ–≤–µ—Ä–∫–∞ flake8"
	@echo "  format     - —Ñ–æ—Ä–º–∞—Ç –∫–æ–¥–∞ black"
	@echo "  clean      - –æ—á–∏—Å—Ç–∫–∞"
	@echo "  setup      - —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞"
	@echo "  manual     - —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞ –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ python"
	@echo "  app        - –∑–∞–π—Ç–∏ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è"
	@echo "  stop		- –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã"
	@echo "  start		- –∑–∞–ø—É—Å—Ç–∏—å –≤—Å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã"


app:
	docker compose exec app bash

stop:
	docker compose stop

start:
	docker compose up -d

setup:
	@if [ ! -f .env ]; then \
		cp .env.example .env; \
	fi

	@echo "üîë –ì–µ–Ω–µ—Ä–∞—Ü–∏—è JWT_SECRET_KEY..."
	@JWT_SECRET_KEY=$$(openssl rand -hex 32); \
	sed -i'' -e "s|JWT_SECRET_KEY=<GENERATED>|JWT_SECRET_KEY=$$JWT_SECRET_KEY|" .env; \
	echo "JWT_SECRET_KEY —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –∏ –¥–æ–±–∞–≤–ª–µ–Ω –≤ .env"

	@echo "üê≥ –ó–∞–ø—É—Å–∫ Docker..."
	docker compose up -d

	@echo "‚úÖ Setup –∑–∞–≤–µ—Ä—à—ë–Ω."

manual:
	@if [ ! -f .env ]; then \
		cp .env.example .env; \
	fi

	@echo "üîë –ì–µ–Ω–µ—Ä–∞—Ü–∏—è JWT_SECRET_KEY..."
	@JWT_SECRET_KEY=$$(openssl rand -hex 32); \
	sed -i'' -e "s|JWT_SECRET_KEY=<GENERATED>|JWT_SECRET_KEY=$$JWT_SECRET_KEY|" .env; \
	echo "JWT_SECRET_KEY —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –∏ –¥–æ–±–∞–≤–ª–µ–Ω –≤ .env"

	@echo "üê≥ –ó–∞–ø—É—Å–∫ Docker..."
	docker compose up celery rabbitmq redis db -d

	@echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π —á–µ—Ä–µ–∑ Poetry..."
	poetry install --no-root

	@echo "üìú –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π..."
	poetry run alembic upgrade head

	@echo "‚úÖ Setup –∑–∞–≤–µ—Ä—à—ë–Ω."


run:
	uvicorn app.main:app --host 0.0.0.0 --port 8000

dev:
	uvicorn app.main:app --reload --host 0.0.0.0 --port 8000

migrate:
	@read -p "Message: " msg; \
	poetry run alembic revision --autogenerate -m "$$msg"

upgrade:
	poetry run alembic upgrade head

seed:
	python scripts/seed.py

test:
	@echo "Running tests..."
	@poetry run pytest -v

test-cov:
	@echo "Running tests with coverage..."
	@poetry run pytest --cov=app --cov-report=term-missing --cov-report=html

test-unit:
	@poetry run pytest tests/unit -v

test-feature:
	@poetry run pytest tests/feature -vv

format:
	@echo "Formatting code with black + isort..."
	@poetry run black app tests
	@poetry run isort app tests

lint:
	@echo "Linting with flake8..."
	@poetry run flake8 app tests

clean:
	find . -type f -name "*.pyc" -delete
	find . -type d -name "__pycache__" -delete
	rm -rf .pytest_cache .coverage htmlcov